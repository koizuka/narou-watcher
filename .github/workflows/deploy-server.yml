name: Deploy Server

on:
  push:
    branches: [ main ]
    paths:
    - '**.go'
    - 'go.sub'
    - 'go.mod'
    - '.github/workflows/deploy-server.yml'
jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Set up Go
      uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
      with:
        go-version: 1.23

    - name: Test
      run: go test -v ./...

    - name: Build
      run: go build -v
      env:
        GOOS: "linux"
        GOARCH: "amd64"
        CGO_ENABLED: "0"

    - name: Setup SSH
      uses: kielabokkie/ssh-key-and-known-hosts-action@242f53d26bbd43e843b08b0cbc8287ceb03fbe71 # v1.5.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        ssh-host: ${{ secrets.SSH_HOST }}
        ssh-port: ${{ secrets.SSH_PORT }}
    
    - name: Deploy
      env:
        REMOTE: "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
        BINARY: "narou-watcher"
        TARGET_DIR: "~/"
        RESTART_COMMAND: "./start.sh"
        SSH: "ssh -p ${{ secrets.SSH_PORT }}"
        SCP: "scp -P ${{ secrets.SSH_PORT }}"
      run: |
        # fix break the file (workaround for ssh-key-and-known-hosts-action)
        echo >> ~/.ssh/known_hosts 

        echo "rename old file"
        $SSH $REMOTE "[ -f $TARGET_DIR$BINARY ] && mv -f $TARGET_DIR$BINARY $TARGET_DIR$BINARY.old"

        echo "scp new file"
        $SCP $BINARY $REMOTE:$TARGET_DIR$BINARY

        echo "restart"
        $SSH $REMOTE ${RESTART_COMMAND}

        echo "verify service is running"
        sleep 5
        if ! $SSH $REMOTE "systemctl is-active --quiet narou-watcher.service"; then
          echo "Service failed to start, checking logs..."
          $SSH $REMOTE "systemctl status narou-watcher.service"
          $SSH $REMOTE "journalctl -u narou-watcher.service --no-pager -n 20"
          exit 1
        fi

        echo "service is running successfully"
        echo "delete old file"
        $SSH $REMOTE rm -f $TARGET_DIR$BINARY.old
