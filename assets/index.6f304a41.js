var le=Object.defineProperty,ce=Object.defineProperties;var ie=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var P=(e,t,r)=>t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,h=(e,t)=>{for(var r in t||(t={}))me.call(t,r)&&P(e,r,t[r]);if(O)for(var r of O(t))de.call(t,r)&&P(e,r,t[r]);return e},v=(e,t)=>ce(e,ie(t));import{r as l,R as o,D as T,H as j,Z as B,u as z,S as fe,M as U,a as pe,b as H,c as W,d as w,e as V,B as C,C as ke,f as Ee,g as he,h as ge,i as x,T as G,j as be,s as ye,k as q,l as X,L as ve,m as Ce,n as xe,o as Be,A as we,p as Ae,q as _e,t as Fe,I as $e,v as De,w as A,x as Re,y as Ie,F as Le,z as Se,E as Me,G as Ke,J as Ne,K as J,N as Q,O as Oe,P as Pe,X as Te,Q as je}from"./vendor.f052277a.js";const ze=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function r(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerpolicy&&(s.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?s.credentials="include":a.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=r(a);fetch(a.href,s)}};ze();class Ue extends Error{constructor(t,r){super(r);this.status=t,this.name="ApiError"}}class b{constructor(t){this.server=t.replace(/\/$/,"")}get baseUrl(){return this.server}async fetch(t){return fetch(`${this.server}${t}`,{credentials:"include"})}async login(t,r){const n=new FormData;return n.append("id",t),n.append("password",r),await fetch(`${this.server}/narou/login`,{method:"POST",body:n,credentials:"include"})}async logout(){await this.fetch("/narou/logout")}async call(t){const r=await this.fetch(t);if(!r.ok)throw new Ue(r.status,await r.text());return r.json()}static isnoticelist({maxPage:t=1}){return`/narou/isnoticelist?max_page=${t}`}static isnoticelistR18({maxPage:t=1}){return`/r18/isnoticelist?max_page=${t}`}static bookmarks(){return"/narou/bookmarks/"}static bookmarksR18(){return"/r18/bookmarks/"}static bookmark(t,{order:r}){return`/narou/bookmarks/${t}?order=${r}`}static bookmarkR18(t,{order:r}){return`/r18/bookmarks/${t}?order=${r}`}static novelInfo(t){return`/narou/novels/${t}`}static novelInfoR18(t){return`/r18/novels/${t}`}}function He(e){const t=new URLSearchParams(e.search).get("server");return t||(e.protocol==="http:"?"http://localhost:7676":/.*\.github\.io$/.test(e.hostname)?"":e.protocol+"//"+e.host+e.pathname)}function We(){const[e,t]=l.exports.useState(null),[r,n]=l.exports.useState(!1);return l.exports.useEffect(()=>{const a=He(document.location);a?t(new b(a)):n(!0)},[]),[e,r]}function Ve(e){return o.createElement("div",{style:{display:"inline-block",position:"fixed",bottom:0,right:0,fontSize:"small",fontStyle:"italic"}},e.name,": ",T.fromISO("2021-11-22T09:53:28.594+00:00").toISO())}function Ge(){return"setAppBadge"in navigator&&"clearAppBadge"in navigator?{setAppBadge:e=>navigator.setAppBadge(e),clearAppBadge:()=>navigator.clearAppBadge()}:{setAppBadge:()=>Promise.resolve(),clearAppBadge:()=>Promise.resolve()}}function qe(){return"setClientBadge"in navigator&&"clearClientBadge"in navigator?{setClientBadge:e=>navigator.setClientBadge(e),clearClientBadge:()=>navigator.clearClientBadge()}:{setClientBadge:()=>Promise.resolve(),clearClientBadge:()=>Promise.resolve()}}function Z(e){return[e.shiftKey?"shift":void 0,e.ctrlKey?"ctrl":void 0,e.altKey?"alt":void 0,e.metaKey?"meta":void 0,e.key].filter(t=>t!==void 0).join("+")}function Xe(e){const[t,...r]=e==="+"?["+"]:e.endsWith("++")?["+",...e.slice(0,-2).split("+").reverse()]:e.split("+").reverse(),n=["shift","ctrl","alt","meta"];if(r.some(s=>!n.includes(s)))throw new Error(`HotKey(${e}): unknown modifiers: ${r.filter(s=>!n.includes(s))}`);const a=Z({key:t,shiftKey:r.some(s=>s==="shift"),ctrlKey:r.some(s=>s==="ctrl"),altKey:r.some(s=>s==="alt"),metaKey:r.some(s=>s==="meta")});if(a!==e)throw new Error(`HotKey(${e}): invalid order: must be ${a} `)}function _(){const[e,t]=l.exports.useState({});return l.exports.useEffect(()=>{const r=Object.keys(e);if(r.length>0){r.forEach(a=>Xe(a));const n=a=>{const s=e[Z(a)];s&&s(a)};return document.addEventListener("keydown",n,!1),()=>{document.removeEventListener("keydown",n)}}},[e]),[t]}function F(){j("/narou/isnoticelist"),j("/r18/isnoticelist")}function Je(e,{enableR18:t,maxPage:r=1,bookmark:n=0}){const{data:a,error:s}=B(b.isnoticelist({maxPage:r}),async d=>e.call(d),{onErrorRetry:d=>{console.log(`onErrorRetry: ${d.status}: ${d}`)}}),u="new",{data:m,error:c}=B(!s&&n?b.bookmark(n,{order:u}):null,async d=>e.call(d)),{data:p,error:i}=B(!s&&t?b.isnoticelistR18({maxPage:r}):null,async d=>e.call(d)),f=l.exports.useMemo(()=>{if(a&&m){const d=new Set(a.map(y=>y.base_url)),k=m.filter(y=>y.is_notice&&!d.has(y.base_url));if(k.length>0)return[...a,...k]}return a},[a,m]),g=l.exports.useMemo(()=>f===void 0?void 0:[...f.map(k=>v(h({},k),{isR18:!1})),...(p||[]).map(k=>v(h({},k),{isR18:!0}))].map(k=>v(h({},k),{update_time:T.fromISO(k.update_time)})),[f,p]);return{data:s?void 0:g,error:s||i||c}}const Y={numNewItems:null,selectedIndex:-1,defaultIndex:-1};function Qe(e,t){switch(t.type){case"set":{if(!t.items)return Y;const r=t.items.sort((s,u)=>Ye(s,u,m=>et(m),s.bookmark<s.latest?m=>m.update_time:Ze(m=>m.update_time),m=>m.base_url)).slice(0,30),n=r[0],a=n&&n.bookmark<n.latest?0:-1;return v(h({},e),{items:r,numNewItems:r.filter(s=>s.bookmark<s.latest).length,selectedIndex:a,defaultIndex:a})}case"select":return v(h({},e),{selectedIndex:e.items?Math.max(Math.min(t.index,e.items.length-1),-1):-1})}}function ee(e,t,r){const n=r(e),a=r(t);return n<a?-1:n>a?1:0}function Ze(e){return{f:e}}function Ye(e,t,...r){for(const n of r){let a;if(typeof n=="object"?a=ee(t,e,n.f):a=ee(e,t,n),a)return a}return 0}const et=e=>e.bookmark===e.latest?Number.MAX_SAFE_INTEGER:e.bookmark>e.latest?Number.MAX_SAFE_INTEGER-1:e.latest-e.bookmark;function tt(e){const t=pe();return z(t.breakpoints.up(e))}function rt({bookmarks:e,bookmark:t,onChangeBookmark:r}){const[n,a]=l.exports.useState(!1),s=tt("sm");return o.createElement(fe,{disableUnderline:!0,variant:"standard",open:n,onOpen:()=>a(!0),onClose:()=>a(!1),value:t,onChange:u=>r(Number(u.target.value))},o.createElement(U,{key:0,value:0},n||s?"\u30D6\u30C3\u30AF\u30DE\u30FC\u30AF\u306A\u3057":"BM-"),e&&Object.keys(e).map(u=>o.createElement(U,{key:u,value:u},n||s?e[Number(u)].name:`BM${t}`)))}function nt(e){const[t,r]=l.exports.useState(""),[n,a]=l.exports.useState(""),[s,u]=l.exports.useState(""),m=l.exports.useCallback(async()=>{const i=await e.api.login(t,n);if(i.ok)e.onLogin();else{const f=await i.text();u(`${i.status} ${i.statusText}
${f}`)}},[t,n,e]),c=l.exports.useRef(),p=l.exports.useCallback(()=>{var i;u(""),(i=c.current)==null||i.focus()},[]);return o.createElement(o.Fragment,null,o.createElement(H,{open:s!=="",onClose:()=>p()},o.createElement(W,null,"\u30ED\u30B0\u30A4\u30F3\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F"),o.createElement(w,null,o.createElement("pre",null,s)),o.createElement(V,null,o.createElement(C,{autoFocus:!0,onClick:()=>p()},"OK"))),o.createElement(ke,{maxWidth:"sm"},o.createElement(Ee,{raised:!0},o.createElement(he,{title:"\u5C0F\u8AAC\u5BB6\u306B\u306A\u308D\u3046\u306E\u30ED\u30B0\u30A4\u30F3\u60C5\u5831","data-testid":"login-page"}),o.createElement(ge,null,o.createElement(x,{display:"flex",flexDirection:"column",justifyContent:"center"},o.createElement(G,{id:"id",name:"id",label:"ID or email",autoFocus:!0,value:t,onChange:i=>r(i.target.value),onKeyPress:i=>{var f;i.key==="Enter"&&((f=c.current)==null||f.focus())},"data-testid":"id"}),o.createElement(G,{id:"password",name:"password",label:"password",type:"password",value:n,onChange:i=>a(i.target.value),inputRef:c,onKeyPress:i=>{i.key==="Enter"&&m()},"data-testid":"password"}))),o.createElement(be,{style:{justifyContent:"center"}},o.createElement(C,{variant:"contained",onClick:m,"data-testid":"login"},"login")))))}function te(e){return e.latest>e.bookmark}function re(e){return te(e)?`${e.base_url}${e.bookmark+1}/`:`${e.base_url}${e.latest}/`}function ot(e){const t=[e.title," ("];return te(e)&&t.push(`${e.bookmark}/`),t.push(`${e.latest})`),e.completed&&t.push("[\u5B8C\u7D50]"),t.join("")}function ne(e){return Math.max(e.latest-e.bookmark,0)}function at(e){return e.latest<e.bookmark?{color:"secondary",badgeContent:"!"}:{color:"primary",badgeContent:ne(e)}}function st({items:e,selectedIndex:t,setSelectedIndex:r,defaultIndex:n,onClick:a}){const s=l.exports.useCallback(c=>{c&&(ye(c,{behavior:"smooth",scrollMode:"if-needed"}),c.focus())},[]),[u]=_();l.exports.useEffect(()=>{if(e){const c=e.length,p=f=>{f.preventDefault(),r(t-1)},i=f=>{f.preventDefault(),r(t+1)};u(h(h(h({},t>0&&{ArrowUp:p,k:p}),t<c-1&&{ArrowDown:i,j:i}),c>0&&{Home:()=>r(0),End:()=>r(c-1),Escape:()=>r(n)}))}else u({})},[n,e,t,u,r]);const m=l.exports.useCallback(c=>ne(c)>0?{component:"a",href:re(c),onClick:()=>r(-1),target:"_blank"}:{disabled:!0},[r]);return e?o.createElement(ve,null,e==null?void 0:e.map((c,p)=>o.createElement(Ce,h(v(h({key:c.base_url,button:!0},p===t?{selected:!0,ref:s}:{}),{disableRipple:!0,onFocusVisible:()=>r(p)}),m(c)),o.createElement(xe,null,o.createElement(Be,h({overlap:"circular"},at(c)),o.createElement(we,null,o.createElement(Ae,{color:c.isR18?"secondary":void 0})))),o.createElement(_e,{primary:ot(c),secondary:`${c.update_time.toFormat("yyyy/LL/dd HH:mm")} \u66F4\u65B0  \u4F5C\u8005:${c.author_name}`}),o.createElement(Fe,null,o.createElement($e,{edge:"end",onClick:()=>a(c),disableRipple:!0,size:"large"},o.createElement(De,null)))))):o.createElement(q,{sx:{color:"#fff",zIndex:c=>c.zIndex.drawer+1},open:!0},o.createElement(X,{color:"inherit"}))}function oe(e,t){const{data:r,error:n}=B(e?t?b.bookmarksR18():b.bookmarks():null,async s=>e?e.call(s):[]);return{data:l.exports.useMemo(()=>{if(r)return r.reduce((s,u)=>(s[u.no]={name:u.name,num_items:u.num_items},s),{})},[r]),error:n}}function ut(e){if(!e)return null;const t=e.match(/https:\/\/([0-9a-zA-Z.]+)\/([0-9a-z]+)\/?/);if(!t)return console.warn(`base_url is invalid: ${e}`),null;const[,r,n]=t;return{host:r,ncode:n}}function lt(e,t){const r=l.exports.useMemo(()=>ut(t),[t]),n=l.exports.useMemo(()=>{if(!r)return null;switch(r.host){case"ncode.syosetu.com":return b.novelInfo(r.ncode);case"novel18.syosetu.com":return b.novelInfoR18(r.ncode);default:return console.warn(`unknown host: ${r.host}`),null}},[r]),{data:a,error:s}=B(n,async u=>e.call(u));return{data:a,error:s}}function ct({api:e,item:t,onClose:r}){const{data:n}=lt(e,t==null?void 0:t.base_url),{data:a}=oe((n==null?void 0:n.bookmark_no)?e:null,(t==null?void 0:t.isR18)||!1),s=l.exports.useMemo(()=>{console.log("novelInfo:",n),console.log("bookmarkInfo:",a);const u=n==null?void 0:n.bookmark_no;if(a&&u&&(n==null?void 0:n.bookmark_url))return{no:u,name:a[u].name,url:n.bookmark_url}},[n,a]);return o.createElement(H,{open:!!t,onClose:r},o.createElement(W,null,t==null?void 0:t.title),o.createElement(w,null,"\u4F5C\u8005:",o.createElement(A,{href:n==null?void 0:n.author_url,target:"_blank"},t==null?void 0:t.author_name)),s&&o.createElement(w,null,"\u30D6\u30C3\u30AF\u30DE\u30FC\u30AF:",o.createElement(A,{href:s.url,target:"_blank"},s.name)),o.createElement(V,null,o.createElement(C,{size:"small",variant:"contained",onClick:()=>{t&&window.open(t.base_url,"_blank"),r()}},"\u5C0F\u8AAC\u30DA\u30FC\u30B8"),o.createElement(C,{size:"small",variant:"contained",onClick:()=>{t&&window.open(re(t),"_blank"),r()}},"\u6700\u65B0",t==null?void 0:t.latest,"\u90E8\u5206"),o.createElement(C,{size:"small",variant:"contained",onClick:()=>r()},"\u30AD\u30E3\u30F3\u30BB\u30EB")))}function it(e,t){const r=Object.keys(e).map(n=>Number(n));for(const n of r)if(n>t)return n;return 0}function mt(e,t){const r=[0,...Object.keys(e).map(a=>Number(a))],n=r.findIndex(a=>a>=t);return n>0?r[n-1]:r[r.length-1]}function dt(e){const[t,r]=l.exports.useState(0),{data:n}=oe(e,!1),[a]=_();return l.exports.useEffect(()=>{a(n?{b:()=>r(it(n,t)),"shift+B":()=>r(mt(n,t))}:{})},[t,n,a]),[t,r,n]}const ae="https://syosetu.com/user/top/";function $(e){return e?2:1}function ft({server:e,onUnauthorized:t}){const[r,n]=l.exports.useState(!1),[a,s]=l.exports.useState($(!1)),[u,m,c]=dt(e),{data:p,error:i}=Je(e,{enableR18:r,maxPage:a,bookmark:u}),[{items:f,numNewItems:g,selectedIndex:d,defaultIndex:k},y]=l.exports.useReducer(Qe,Y);l.exports.useEffect(()=>{y({type:"set",items:p})},[p]);const D=E=>y({type:"select",index:E}),[ue,R]=l.exports.useState(void 0),{setAppBadge:I,clearAppBadge:L}=Ge(),{setClientBadge:S,clearClientBadge:M}=qe();l.exports.useEffect(()=>{g!==null&&(document.title=`\u306A\u308D\u3046 \u672A\u8AAD:${g}`,g?(I(g),S(g)):(L(),M()))},[L,M,g,I,S]);const K=l.exports.useRef(null);l.exports.useEffect(()=>{var E;d===-1&&((E=K.current)==null||E.focus())},[d]);const[N]=_();return l.exports.useEffect(()=>{N({r:()=>n(E=>!E),"1":()=>s(E=>$(E===$(!1))),h:()=>window.open(ae,"_blank")})},[N]),i?(console.log(`error = ${i}`),i.status===401&&t(),o.createElement("div",{onClick:()=>window.location.reload()},o.createElement("p",null,"Server(",JSON.stringify(e.baseUrl),") is not working...?"),o.createElement("p",null,"status: ",i.status),o.createElement("code",null,i.message))):f?o.createElement(o.Fragment,null,o.createElement(ct,{api:e,item:ue,onClose:()=>R(void 0)}),o.createElement(Re,{position:"sticky"},o.createElement(Ie,null,o.createElement(x,null,o.createElement(Le,{label:"R18",control:o.createElement(Se,{checked:r,onChange:E=>n(E.target.checked)})})),o.createElement(x,null,o.createElement(rt,{bookmarks:c,bookmark:u,onChangeBookmark:m})),o.createElement(x,{m:2},"\u672A\u8AAD: ",g!=null?g:""),o.createElement(C,{variant:"contained",disabled:d===0,disableRipple:!0,ref:K,onClick:()=>D(k)},"ESC"))),o.createElement(x,{m:2,display:"flex",alignItems:"center",flexDirection:"column",bgcolor:"background.paper"},o.createElement(x,{maxWidth:600},o.createElement(st,{items:f,selectedIndex:d,setSelectedIndex:D,defaultIndex:k,onClick:R})),o.createElement(x,{position:"fixed",right:"20px",bottom:"20px"},o.createElement(Me,{variant:"extended",size:"small",disableRipple:!0,component:"a",href:ae,target:"_blank"},"\u30E6\u30FC\u30B6\u30FC\u30DB\u30FC\u30E0")))):o.createElement(q,{sx:{color:"#fff",zIndex:E=>E.zIndex.drawer+1},open:!0},o.createElement(X,{color:"inherit"}))}function pt({api:e}){const[t,r]=l.exports.useState(!1),n=l.exports.useCallback(()=>{setTimeout(()=>{F(),r(!0)},0)},[]);return t?o.createElement(nt,{api:e,onLogin:()=>{console.log("logged in!"),F(),r(!1)}}):o.createElement(o.Fragment,null,o.createElement(ft,{server:e,onUnauthorized:n}),o.createElement(C,{onClick:async()=>{await e.logout(),F(),r(!0)}},"logout"))}function kt(){const e=z("(prefers-color-scheme: dark)");return l.exports.useMemo(()=>Ke({palette:{mode:e?"dark":"light",primary:Ne}}),[e])}const Et=5*60*1e3;function ht(){const e=kt(),[t,r]=We();return r?o.createElement(J,{injectFirst:!0},o.createElement(Q,{theme:e},o.createElement(Oe,null,"http\u4EE5\u5916\u306E\u5834\u5408\u306F\u5FC5\u305A server \u30AF\u30A8\u30EA\u30D1\u30E9\u30E1\u30FC\u30BF\u306B\u30B5\u30FC\u30D0\u30FC\u30A2\u30C9\u30EC\u30B9\u3092\u6307\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044"),o.createElement(A,{href:"https://github.com/koizuka/narou-watcher/"},"GitHub"))):o.createElement(J,{injectFirst:!0},o.createElement(Q,{theme:e},o.createElement(Pe,null),o.createElement(Te,{value:{refreshInterval:Et}},t&&o.createElement(pt,{api:t})),o.createElement(Ve,{name:"narou-react"})))}const gt="modulepreload",se={},bt="/narou/",yt=function(t,r){return!r||r.length===0?t():Promise.all(r.map(n=>{if(n=`${bt}${n}`,n in se)return;se[n]=!0;const a=n.endsWith(".css"),s=a?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${n}"]${s}`))return;const u=document.createElement("link");if(u.rel=a?"stylesheet":gt,a||(u.as="script",u.crossOrigin=""),u.href=n,document.head.appendChild(u),a)return new Promise((m,c)=>{u.addEventListener("load",m),u.addEventListener("error",c)})})).then(()=>t())},vt=e=>{e&&e instanceof Function&&yt(()=>import("./web-vitals.8eea515e.js"),[]).then(({getCLS:t,getFID:r,getFCP:n,getLCP:a,getTTFB:s})=>{t(e),r(e),n(e),a(e),s(e)})};je.render(o.createElement(o.StrictMode,null,o.createElement(ht,null)),document.getElementById("root"));vt();
